<!DOCTYPE html>
<html lang="ku">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستەمی قەرزی - رۆنیکا</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>سیستەمی قەرز - رۆنیکا</title>
    
   <meta name="theme-color" content="#3498db">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="manifest" href="./manifest.json">
<link rel="icon" href="./icons/icon-192.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vazirmatn@latest/Vazirmatn-font-face.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
      /* مدیریت صفحه‌بندی برای PDF */
@media print {
    .excel-table {
        page-break-inside: avoid;  /* از شکستن جدول در وسط جلوگیری میکند */
        break-inside: avoid;       /* نسخه مدرن برای جلوگیری از شکستن */
    }
    
    .excel-style-report {
        page-break-inside: avoid;  /* از شکستن گزارش در وسط جلوگیری میکند */
        break-inside: avoid;       /* نسخه مدرن */
    }
}

/* کلاس برای جلوگیری از شکستن صفحه */
.keep-together {
    page-break-inside: avoid;      /* المان در یک صفحه میماند */
    break-inside: avoid;           /* نسخه مدرن */
}

      /* استایل‌های جدید برای گزارشات - تم اکسلی */
.excel-style-report {
    background: #ffffff;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.excel-header {
    background: linear-gradient(135deg, #2c3e50, #34495e);
    color: white;
    padding: 20px;
    text-align: center;
    border-bottom: 3px solid #3498db;
}

.excel-header h3 {
    margin: 0;
    font-size: 24px;
    font-weight: 700;
}

.excel-subheader {
    background: #f8f9fa;
    padding: 15px 20px;
    border-bottom: 1px solid #dee2e6;
    font-weight: 600;
    color: #495057;
}

.excel-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 0;
}

.excel-card {
    padding: 20px;
    border-right: 1px solid #dee2e6;
    border-bottom: 1px solid #dee2e6;
    background: #fff;
}

.excel-card:last-child {
    border-right: none;
}

.excel-card h4 {
    color: #2c3e50;
    margin-bottom: 15px;
    font-size: 16px;
    font-weight: 700;
    border-bottom: 2px solid #3498db;
    padding-bottom: 8px;
}

.excel-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid #f8f9fa;
}

.excel-item:last-child {
    border-bottom: none;
}

.excel-item label {
    font-weight: 600;
    color: #495057;
    font-size: 16px;
}

.excel-item span {
    color: #e74c3c;
    font-weight: 700;
    font-size: 16px;
}

.excel-history {
    padding: 20px;
}

.excel-history h4 {
    color: #2c3e50;
    margin-bottom: 15px;
    font-size: 16px;
    font-weight: 700;
    border-bottom: 2px solid #3498db;
    padding-bottom: 8px;
}

.excel-history-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.excel-history-item {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 15px;
    padding: 12px 15px;
    background: #f8f9fa;
    border-radius: 6px;
    border-right: 4px solid #27ae60;
    align-items: center;
}

.excel-history-number {
    color: #2c3e50;
    font-weight: 600;
}

.excel-history-amount {
    color: #e74c3c;
    font-weight: 700;
    text-align: left;
}

.excel-history-date {
    color: #7f8c8d;
    text-align: left;
}

/* دکمه PDF */
.pdf-btn-container {
    display: flex;
    justify-content: flex-end; /* سمت چپ */
    margin: 20px 0;
}

.btn-pdf {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 2px 4px rgba(231, 76, 60, 0.3);
}

.btn-pdf:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(231, 76, 60, 0.4);
    background: linear-gradient(135deg, #c0392b, #a93226);
}

/* وسط چین کردن کل تب‌ها و کارت‌ها */
.tab-content {
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.installment-container,
.form-container {
    width: 100%;
    max-width: 900px;
    margin: 0 auto;
}

.excel-style-report {
    margin: 0 auto;
    max-width: 1000px;
}

.excel-grid {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
}

.excel-card {
    width: 100%;
    max-width: 600px;
    margin: 0 auto;
}

/* تم اکسلی واقعی با جدول */
.excel-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
    font-size: 16px;
    background: white;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.excel-table th {
    background: linear-gradient(135deg, #2c3e50, #34495e);
    color: white;
    padding: 12px 15px;
    text-align: center;
    border: 1px solid #1a252f;
    font-weight: 700;
}

.excel-table td {
    padding: 10px 15px;
    border: 1px solid #ddd;
    text-align: center;
}

.excel-table tr:nth-child(even) {
    background-color: #f8f9fa;
}

.excel-table tr:hover {
    background-color: #e3f2fd;
}

.excel-table .total-row {
    background: #e8f5e8 !important;
    font-weight: 700;
    border-top: 2px solid #27ae60;
}

.excel-table .total-row td {
    color: #2c3e50;
    font-size: 15px;
}

.excel-table .amount {
    font-weight: 700;
    color: #e74c3c;
}

.excel-table .paid {
    font-weight: 700;
    color: #27ae60;
}

.excel-table .remaining {
    font-weight: 700;
    color: #e67e22;
}

.excel-table .loan-header {
    background: #3498db !important;
    color: white;
    font-size: 16px;
    font-weight: 700;
}

/* وسط چین کردن کامل برای گزارشات */
.excel-style-report {
    text-align: center;
    margin: 0 auto;
}

/* بهبود مدیریت صفحه‌بندی برای PDF */
.excel-table {
    page-break-inside: auto !important;
}

.excel-table tr {
    page-break-inside: avoid !important;
    page-break-after: auto !important;
}

.excel-table td, .excel-table th {
    page-break-inside: avoid !important;
}

/* اطمینان از اینکه ردیف‌ها با هم می‌مانند */
.excel-table tbody tr {
    break-inside: avoid-page !important;
}

/* اینجا استایل‌های جدید PDF را اضافه کن: */

/* مدیریت صفحه‌بندی برای PDF */
@media print {
    .excel-table {
        page-break-inside: avoid;
        break-inside: avoid;
    }
    
    .excel-style-report {
        page-break-inside: avoid;
        break-inside: avoid;
    }
}

/* کلاس برای جلوگیری از شکستن صفحه */
.keep-together {
    page-break-inside: avoid;
    break-inside: avoid;
}

/* و اینجا ادامه استایل‌های موجود */
@media (max-width: 768px) {
    /* استایل‌های موبایل */
}

@media (max-width: 768px) {
    .excel-grid {
        grid-template-columns: 1fr;
    }
    
    .excel-history-item {
        grid-template-columns: 1fr;
        gap: 8px;
    }
}
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Vazirmatn, sans-serif;
        }

        body {
            font-family: Vazirmatn, sans-serif;
            line-height: 1.6;
            background-color: #f5f5f5;
            color: #333;
            direction: rtl;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        header h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 24px;
            border: none;
            background: #ecf0f1;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 500;
        }

        .tab-button:hover {
            background: #d5dbdb;
        }

        .tab-button.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .tab-content h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .form-container {
            max-width: 800px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .amount-input {
            text-align: left;
            direction: ltr;
        }

        .readonly {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            position: relative;
        }

        .btn-primary,
        .btn-secondary {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #27ae60;
            color: white;
        }

        .btn-primary:hover {
            background: #219a52;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .success-message {
            color: #27ae60;
            font-weight: bold;
            margin-top: 10px;
            text-align: center;
            padding: 10px;
            background: #d4edda;
            border-radius: 5px;
            display: none;
        }

        .info-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-right: 4px solid #3498db;
        }

        .info-card h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
            font-size: 16px;
        }

        .card-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .card-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .card-item label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
        }

        .card-item span {
            color: #e74c3c;
            font-weight: 600;
            font-size: 13px;
        }

        .history-section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .history-section h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 5px;
            border-right: 3px solid #27ae60;
        }

        .history-item span {
            font-weight: 500;
        }

        .history-number {
            color: #2c3e50;
            min-width: 100px;
        }

        .history-amount {
            color: #e74c3c;
            font-weight: 600;
            min-width: 120px;
            text-align: left;
        }

        .history-date {
            color: #7f8c8d;
            min-width: 120px;
            text-align: left;
        }

        .installment-container {
            max-width: 600px;
        }

        .report-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-right: 4px solid #3498db;
        }

        .investors-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            margin-bottom: 30px;
        }

        .investors-table th,
        .investors-table td {
            padding: 12px;
            text-align: right;
            border: 1px solid #ddd;
        }

        .investors-table th {
            background: #3498db;
            color: white;
        }

        .investors-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .summary-section {
            margin-top: 30px;
            padding: 20px;
            background: #e8f5e8;
            border-radius: 8px;
            border: 1px solid #27ae60;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .info-item label {
            font-weight: 600;
            color: #2c3e50;
        }

        .info-item span {
            color: #e74c3c;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #3498db;
        }

        .error-message {
            color: #e74c3c;
            background: #fadbd8;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        .test-connection-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* استایل‌های جدید برای تب گزارشات */
        .modern-dashboard {
    background: linear-gradient(135deg, #2c3e50, #34495e);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .dashboard-header h2 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 700;
            color: white;
        }
        
        .dashboard-header p {
            opacity: 0.9;
            font-size: 16px;
        }
        .dashboard-header h2 {
    color: white !important;
    font-weight: 700;
}

        .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}
        
        .stat-card {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 25px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    transition: all 0.3s ease;
}
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }
        
        .stat-card.primary {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
        }
        
        .stat-card.success {
            background: linear-gradient(135deg, #1dd1a1, #10ac84);
        }
        
        .stat-card.warning {
            background: linear-gradient(135deg, #feca57, #ff9f43);
        }
        
        .stat-card.info {
            background: linear-gradient(135deg, #54a0ff, #2e86de);
        }

        .stat-card:nth-child(1) { background: linear-gradient(135deg, #3498db, #2980b9); }
.stat-card:nth-child(2) { background: linear-gradient(135deg, #1abc9c, #16a085); }
.stat-card:nth-child(3) { background: linear-gradient(135deg, #9b59b6, #8e44ad); }
.stat-card:nth-child(4) { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        
        .stat-icon {
            font-size: 40px;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 500;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid #e8e8e8;
        }
        
        .chart-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 2px solid #f8f9fa;
            padding-bottom: 10px;
        }
        
        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
        }
        
        .progress-bg {
            fill: none;
            stroke: #ecf0f1;
            stroke-width: 8;
        }
        
        .progress-fill {
            fill: none;
            stroke: #3498db;
            stroke-width: 8;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 0.3s ease;
        }
        
        .progress-text {
            text-anchor: middle;
            dominant-baseline: middle;
            font-size: 24px;
            font-weight: bold;
            fill: #2c3e50;
        }
        
        .progress-label {
            text-align: center;
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .loan-distribution {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .distribution-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-right: 4px solid #3498db;
        }
        
        .distribution-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .distribution-info {
            flex: 1;
        }
        
        .distribution-value {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .distribution-label {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        
        .action-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .action-btn.success {
            background: linear-gradient(135deg, #27ae60, #219a52);
        }
        
        .action-btn.warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .update-btn {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .update-btn:hover {
            background: #8e44ad;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .info-cards {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .investors-table {
                font-size: 12px;
            }
            
            .card-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .history-item {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
            
            .history-number,
            .history-amount,
            .history-date {
                min-width: auto;
                text-align: right;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .modern-dashboard {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>سیستەمی قەرزی - رۆنیکا</h1>
            <nav class="tabs">
                <button class="tab-button active" onclick="openTab('new-loan')">قەرزی نوێ</button>
                <button class="tab-button" onclick="openTab('receive-installment')">وەرگرتنی قیست</button>
                <button class="tab-button" onclick="openTab('waragr-reports')">راپۆرتی وەرگرەکان</button>
                <button class="tab-button" onclick="openTab('reports')">ڕاپۆرتەکان</button>
                <button class="tab-button" onclick="openTab('investors')">خاوەن پشکەکان</button>
            </nav>
        </header>

        <!-- تب قەرزی نوێ -->
        <div id="new-loan" class="tab-content active">
            <h2>تۆمارکردنی قەرزی نوێ</h2>
            <form id="loan-form" class="form-container">
                <div class="form-group">
                    <label for="waragr">ناوی وەرگر</label>
                    <input type="text" id="waragr" required>
                </div>
                
                <div class="form-group">
                    <label for="mobile-waragr">مۆبایلی وەرگر</label>
                    <input type="text" id="mobile-waragr">
                </div>

                <div class="form-group">
                    <label for="jor-qist">جۆری قیست</label>
                    <input type="text" id="jor-qist">
                </div>

                <div class="form-group">
                    <label for="beruar">بەروار</label>
                    <input type="date" id="beruar" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="kreen">کرین (مەبلەغی قەرز)</label>
                        <input type="text" id="kreen" class="amount-input" required>
                    </div>

                    <div class="form-group">
                        <label for="froshtn">فرۆشتن (مەبلەغ دوای قازانج)</label>
                        <input type="text" id="froshtn" class="amount-input" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="nerxi-sud">نرخی قازانج (%)</label>
                    <input type="text" id="nerxi-sud" readonly class="readonly">
                </div>

                <div class="form-group">
                    <label for="chenda-mang">بە چەند مانگ</label>
                    <input type="number" id="chenda-mang" min="1" max="36" required>
                </div>

                <div class="form-group">
                    <label for="kafeel">کەفیل</label>
                    <input type="text" id="kafeel">
                </div>

                <div class="form-group">
                    <label for="mobile-kafeel">مۆبایلی کەفیل</label>
                    <input type="text" id="mobile-kafeel">
                </div>

                <div class="form-group">
                    <label for="froshyar">فرۆشیار</label>
                    <input type="text" id="froshyar">
                </div>

                <div class="form-group">
                    <label for="notes">تێبینی (نۆت)</label>
                    <textarea id="notes" rows="3" placeholder="هەر تێبینێک کە پێویستە..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">تۆمارکردنی قەرز</button>
                    <button type="reset" class="btn-secondary">پاککردنەوە</button>
                    <div id="loan-success" class="success-message">تۆمار کرا</div>
                </div>
            </form>
        </div>

        <!-- تب وەرگرتنی قیست -->
        <div id="receive-installment" class="tab-content">
            <h2>وەرگرتنی قیست</h2>
            <!-- دکمه PDF -->
<div class="pdf-btn-container">
    <button class="btn-pdf" onclick="generatePDF('receive-installment')">
        📄 دەرکردنی PDF
    </button>
</div>
            <div class="installment-container">
                
                <div class="form-group">
                    <label for="select-waragr">هەڵبژاردنی وەرگر</label>
                    <select id="select-waragr">
                        <option value="">هەڵبژاردنی وەرگر</option>
                    </select>
                </div>

                <div id="loan-type-selection" style="display: none;">
                    <div class="form-group">
                        <label for="select-loan-type">هەڵبژاردنی جۆری قەرز</label>
                        <select id="select-loan-type">
                            <option value="">هەڵبژاردنی جۆری قەرز</option>
                        </select>
                    </div>
                </div>

                <form id="installment-form" class="form-container">
                    <div class="form-group">
                        <label for="installment-amount">مەبلەغی قیست</label>
                        <input type="text" id="installment-amount" class="amount-input" required>
                    </div>

                    <div class="form-group">
                        <label for="installment-date">بەرواری قیست</label>
                        <input type="date" id="installment-date" required>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary">تۆمارکردنی قیست</button>
                        <div id="installment-success" class="success-message">تۆمار کرا</div>
                    </div>
                </form>

                <!-- گزارش کامل -->
                <div id="customer-report" class="report-section" style="display: none;">
                    <!-- محتوای گزارش توسط JavaScript پر می‌شود -->
                </div>
            </div>
        </div>

        <!-- تب راپۆرتی وەرگرەکان -->
        <div id="waragr-reports" class="tab-content">
            <h2>راپۆرتی وەرگرەکان</h2>
            <!-- دکمه PDF -->
<div class="pdf-btn-container">
    <button class="btn-pdf" onclick="generatePDF('waragr-reports')">
        📄 دەرکردنی PDF
    </button>
</div>
            <div class="form-container">
                <div class="form-group">
                    <label for="select-unique-waragr">هەڵبژاردنی وەرگر</label>
                    <select id="select-unique-waragr">
                        <option value="">هەڵبژاردنی وەرگر</option>
                    </select>
                </div>
                
                <div id="all-loans-report" class="report-section" style="display: none;">
                    <!-- محتوای گزارش کامل وەرگر -->
                </div>
            </div>
        </div>



        <!-- تب گزارشات -->
        <div id="reports" class="tab-content">
            <div class="modern-dashboard">
                <div class="dashboard-header">
                    <h2>داشبۆردی گشتی</h2>
                    <p>زانیارییەکانی کۆی سیستەمی قەرز</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <div class="stat-icon">💰</div>
                        <div class="stat-value" id="total-remaining">0</div>
                        <div class="stat-label">کۆی مەبلەغی باقیماندەی قەرزەکان</div>
                    </div>

                    <!-- در stats-grid یک کارت جدید اضافه کن -->
<div class="stat-card" style="background: linear-gradient(135deg, #1abc9c, #16a085);">
    <div class="stat-icon">🏦</div>
    <div class="stat-value" id="fund-balance">0</div>
    <div class="stat-label">پارەی بەردەست (قاصە)</div>
</div>

<!-- کارت جدید -->
    <div class="stat-card" style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
        <div class="stat-icon">💳</div>
        <div class="stat-value" id="total-kreen">0</div>
        <div class="stat-label">کۆی گشتی کرین</div>
    </div>
                    
                    <div class="stat-card success">
                        <div class="stat-icon">📊</div>
                        <div class="stat-value" id="total-received">0</div>
                        <div class="stat-label">کۆی وەرگیراو</div>
                    </div>
                    
                    <div class="stat-card warning">
                        <div class="stat-icon">📈</div>
                        <div class="stat-value" id="total-amount">0</div>
                        <div class="stat-label">کۆی مەبلەغی قەرزەکان</div>
                    </div>
                    
                    <div class="stat-card info">
                        <div class="stat-icon">📋</div>
                        <div class="stat-value" id="total-loans">0</div>
                        <div class="stat-label">کۆی قەرزەکان</div>
                    </div>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <h3>ڕێژەی تەواوبوون</h3>
                    <div class="progress-ring">
                        <svg width="120" height="120" viewBox="0 0 120 120">
                            <circle class="progress-bg" cx="60" cy="60" r="54"></circle>
                            <circle class="progress-fill" cx="60" cy="60" r="54" 
                                    stroke-dasharray="339.292" stroke-dashoffset="339.292"
                                    id="completion-ring"></circle>
                            <text class="progress-text" x="60" y="60" id="completion-text">0%</text>
                        </svg>
                    </div>
                    <div class="progress-label">کۆی وەرگیراو لە کۆی قەرزەکان</div>
                </div>
                
                <div class="chart-card">
                    <h3>دابەشکاری قەرزەکان</h3>
                    <div class="loan-distribution">
                        <div class="distribution-item">
                            <div class="distribution-color" style="background: #27ae60;"></div>
                            <div class="distribution-info">
                                <div class="distribution-value" id="active-loans">0</div>
                                <div class="distribution-label">قەرزە چالاکەکان</div>
                            </div>
                        </div>
                        <div class="distribution-item">
                            <div class="distribution-color" style="background: #e74c3c;"></div>
                            <div class="distribution-info">
                                <div class="distribution-value" id="completed-loans">0</div>
                                <div class="distribution-label">قەرزە تەواوکراوەکان</div>
                            </div>
                        </div>
                        <div class="distribution-item">
                            <div class="distribution-color" style="background: #f39c12;"></div>
                            <div class="distribution-info">
                                <div class="distribution-value" id="total-profit">0</div>
                                <div class="distribution-label">کۆی قازانج</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="info-cards">
                <div class="info-card">
                    <h4>زانیارییەکی گشتی</h4>
                    <div class="card-content">
                        <div class="card-item">
                            <label>تێکڕای مەبلەغی قەرز:</label>
                            <span id="avg-loan-amount">0 دینار</span>
                        </div>
                        <div class="card-item">
                            <label>تێکڕای وەرگیراو بۆ هەر قەرزێک:</label>
                            <span id="avg-received">0 دینار</span>
                        </div>
                        <div class="card-item">
                            <label>تێکڕای ماوە بۆ هەر قەرزێک:</label>
                            <span id="avg-remaining">0 دینار</span>
                        </div>
                    </div>
                </div>
                
                <div class="info-card">
                    <h4>ڕێژەکان</h4>
                    <div class="card-content">
                        <div class="card-item">
                            <label>ڕێژەی قەرزە چالاکەکان:</label>
                            <span id="active-rate">0%</span>
                        </div>
                        <div class="card-item">
                            <label>ڕێژەی قەرزە تەواوکراوەکان:</label>
                            <span id="completed-rate">0%</span>
                        </div>
                        <div class="card-item">
                            <label>ڕێژەی قازانج:</label>
                            <span id="profit-rate">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="quick-actions">
                <button class="action-btn" onclick="openTab('new-loan')">
                    ➕ قەرزی نوێ
                </button>
                <button class="action-btn success" onclick="openTab('receive-installment')">
                    💰 وەرگرتنی قیست
                </button>
                <button class="action-btn warning" onclick="openTab('waragr-reports')">
                    📊 راپۆرتی وەرگرەکان
                </button>
            </div>
        </div>

    <!-- تب خاوەن پشکەکان -->
<div id="investors" class="tab-content">
    <h2>خاوەن پشکەکان</h2>
    <div id="investors-content">
        <p>بارکردنی زانیاری خاوەن پشکەکان...</p>
    </div>
</div>

    <script>
        // تابع اصلی برای لود صفحه
        document.addEventListener('DOMContentLoaded', function() {
            console.log('صفحه لود شد');
            initializeApp();
            setupEventListeners();
            loadWaragrList();
        });

        // مقداردهی اولیه برنامه
        function initializeApp() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('beruar').value = today;
            document.getElementById('installment-date').value = today;
            console.log('داتا سەرەتاییەکان وەرگیران');
        }

      // تنظیم event listeners - نسخه اصلاح شده
function setupEventListeners() {
    document.getElementById('loan-form').addEventListener('submit', handleNewLoan);
    document.getElementById('installment-form').addEventListener('submit', handleInstallment);
    document.getElementById('kreen').addEventListener('input', calculateSud);
    document.getElementById('froshtn').addEventListener('input', calculateSud);
    document.getElementById('select-waragr').addEventListener('change', handleWaragrSelection);
    document.getElementById('select-unique-waragr').addEventListener('change', loadAllLoansForWaragr);
    
    // این خط مهم را اضافه کن
    document.getElementById('select-loan-type').addEventListener('change', loadWaragrInfo);
    
    setupNumberFormatting();
    console.log('Event listeners رێک خران');
}

        // فرمت کردن اعداد به صورت سه رقم سه رقم
        function setupNumberFormatting() {
            const amountInputs = document.querySelectorAll('.amount-input');
            amountInputs.forEach(input => {
                input.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/,/g, '');
                    if (!isNaN(value) && value !== '') {
                        e.target.value = Number(value).toLocaleString();
                    }
                });
            });
        }

        // محاسبه درصد سود
        function calculateSud() {
            const kreen = document.getElementById('kreen');
            const froshtn = document.getElementById('froshtn');
            const nerxiSud = document.getElementById('nerxi-sud');
            
            const kreenValue = parseFloat(kreen.value.replace(/,/g, '')) || 0;
            const froshtnValue = parseFloat(froshtn.value.replace(/,/g, '')) || 0;
            
            if (kreenValue > 0 && froshtnValue > 0) {
                const sudPercentage = ((froshtnValue - kreenValue) / kreenValue * 100).toFixed(2);
                nerxiSud.value = sudPercentage + '%';
            } else {
                nerxiSud.value = '';
            }
        }

        // لود لیست وەرگرەکان برای تب وەرگرتنی قیست
        function loadWaragrList() {
            console.log('ئامادەکردنی ناوی وەرگرەکان...');
            const select = document.getElementById('select-waragr');
            select.innerHTML = '<option value="">هەڵبژاردنی وەرگر</option>';
            
            google.script.run
                .withSuccessHandler(function(waragrList) {
                    console.log('لیستی وەرگرەکان وەرگیرا:', waragrList);
                    
                    waragrList.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.name;
                        option.textContent = `${item.name} - ${item.type} - ${Number(item.amount).toLocaleString()}`;
                        option.setAttribute('data-type', item.type);
                        select.appendChild(option);
                    });
                })
                .withFailureHandler(function(error) {
                    console.error('هەلە لە وەرگرتنی وەرگرەکان:', error);
                    showError('هەلە لە ئامادەکردنی وەرگرەکان: ' + error);
                })
                .getWaragrList();
        }

// مدیریت انتخاب وەرگر - نسخه اصلاح شده
function handleWaragrSelection() {
    const waragrName = this.value;
    console.log('وەرگر هەلبژێردرا:', waragrName);
    loadLoanTypesForWaragr(waragrName);
    
    // ابتدا گزارش را پاک کن
    document.getElementById('customer-report').style.display = 'none';
    document.getElementById('customer-report').innerHTML = '';
}

// لود انواع وام یک وەرگر - نسخه اصلاح شده
function loadLoanTypesForWaragr(waragrName) {
    const typeSelect = document.getElementById('select-loan-type');
    const typeSelection = document.getElementById('loan-type-selection');
    
    if (!waragrName) {
        typeSelection.style.display = 'none';
        typeSelect.innerHTML = '<option value="">هەڵبژاردنی جۆری قەرز</option>';
        return;
    }
    
    typeSelect.innerHTML = '<option value="">هەڵبژاردنی جۆری قەرز</option>';
    
    google.script.run
        .withSuccessHandler(function(waragrList) {
            const types = waragrList.filter(item => item.name === waragrName);
            console.log('جۆرەکانی قەرز بۆ', waragrName, ':', types);
            
            if (types.length > 1) {
                typeSelection.style.display = 'block';
                types.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.type;
                    option.textContent = `${item.type} - ${Number(item.amount).toLocaleString()} دینار`;
                    typeSelect.appendChild(option);
                });
                
                // اگر فقط یک جۆری قەرز دارد، بلافاصله گزارش را نشان بده
                if (types.length === 1) {
                    typeSelect.value = types[0].type;
                    loadWaragrInfo();
                }
            } else {
                typeSelection.style.display = 'none';
                if (types.length === 1) {
                    typeSelect.value = types[0].type;
                    loadWaragrInfo();
                }
            }
        })
        .withFailureHandler(function(error) {
            console.error('هەلە لە وەرگرتنی جۆری قەرزەکان:', error);
            typeSelection.style.display = 'none';
        })
        .getWaragrList();
}

// اضافه کردن event listener برای تغییر جۆری قەرز
document.addEventListener('DOMContentLoaded', function() {
    // این خط را اضافه کن
    document.getElementById('select-loan-type').addEventListener('change', function() {
        console.log('جۆری قەرز گۆردرا بۆ:', this.value);
        loadWaragrInfo();
    });
});

// لود اطلاعات وەرگر انتخاب شده - نسخه کاملاً اصلاح شده
function loadWaragrInfo() {
    const select = document.getElementById('select-waragr');
    const typeSelect = document.getElementById('select-loan-type');
    const customerReport = document.getElementById('customer-report');
    const waragrName = select.value;
    const loanType = typeSelect.value;
    
    console.log('لۆدکردنی زانیاریەکانی - وەرگر:', waragrName, 'جۆری قەرز:', loanType);
    
    if (!waragrName) {
        customerReport.style.display = 'none';
        customerReport.innerHTML = '';
        return;
    }
    
    // اگر چند وام دارد اما جۆری قەرز انتخاب نشده، منتظر بمان
    const typeSelection = document.getElementById('loan-type-selection');
    if (typeSelection.style.display === 'block' && !loanType) {
        customerReport.style.display = 'none';
        customerReport.innerHTML = '<div class="loading">جۆری قەرز هەلبژێرە...</div>';
        return;
    }
    
    // نمایش لودینگ
    customerReport.style.display = 'block';
    customerReport.innerHTML = '<div class="loading">ئامادەکردنی زانیاریەکانی ئەم قەرزە...</div>';
    
    console.log('ناردن بۆ سێرڤەر:', { waragrName: waragrName, loanType: loanType });
    
    google.script.run
        .withSuccessHandler(function(customerData) {
            console.log('داتاکان وەرگیران:', customerData);
            displayCustomerReport(customerData);
        })
        .withFailureHandler(function(error) {
            console.error('هەلەیەک لە وەرگرتنی زانیاریەکان:', error);
            customerReport.innerHTML = `
                <div class="error-message">
                    هەلە لە ئامادەکردنی زانیاریەکان: ${error}
                    <br>
                    <button class="test-connection-btn" onclick="testConnection()">تێستی سێرڤەر</button>
                </div>
            `;
        })
        .getWaragrInfo(waragrName, loanType);
}

        // لود لیست یونیک وەرگرەکان برای تب راپۆرتی وەرگرەکان
        function loadUniqueWaragrList() {
            console.log('ئامادەکردنی لیستی یونیک بۆ وەرگرەکان...');
            const select = document.getElementById('select-unique-waragr');
            select.innerHTML = '<option value="">هەڵبژاردنی وەرگر</option>';
            
            google.script.run
                .withSuccessHandler(function(waragrList) {
                    console.log('لیستی یونیکی وەرگرەکان وەرگیرا:', waragrList);
                    
                    waragrList.forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        select.appendChild(option);
                    });
                })
                .withFailureHandler(function(error) {
                    console.error('هەلە لە لیستی یونیکی وەرگرەکان:', error);
                    showError('هەلە لە ئامادەکردنی لیستی وەرگرەکان: ' + error);
                })
                .getUniqueWaragrNames();
        }

        // لود تمام وام‌های یک وەرگر
        function loadAllLoansForWaragr() {
            const select = document.getElementById('select-unique-waragr');
            const reportDiv = document.getElementById('all-loans-report');
            const waragrName = select.value;
            
            if (!waragrName) {
                reportDiv.style.display = 'none';
                return;
            }
            
            reportDiv.style.display = 'block';
            reportDiv.innerHTML = '<div class="loading">ئامادەکردنی گشت زانیاریەکانی وەرگر...</div>';
            
            google.script.run
                .withSuccessHandler(function(data) {
                    displayAllLoansReport(data);
                })
                .withFailureHandler(function(error) {
                    console.error('هەلە لە ئامادەکردنی زانیاری گشت قەرزەکان:', error);
                    reportDiv.innerHTML = `
                        <div class="error-message">
                            هەلە لە ئامادەکردنی زانیاریەکان: ${error}
                        </div>
                    `;
                })
                .getAllLoansForWaragr(waragrName);
        }

    function displayCustomerReport(data) {
    const customerReport = document.getElementById('customer-report');
    
    if (data.error) {
        customerReport.innerHTML = `
            <div class="error-message">
                ${data.error}
            </div>
        `;
        return;
    }
    
    const html = `
        <div class="excel-style-report">
            <div class="excel-header">
                <h3>ڕاپۆرتی وەرگر - ${data.waragrName}</h3>
            </div>
            
            <div class="excel-subheader">
                <strong>جۆری قەرز:</strong> ${data.loanType}
            </div>

            <!-- جدول اکسلی -->
            <table class="excel-table">
                <thead>
                    <tr>
                        <th>زانیاری</th>
                        <th>بڕ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>کۆی مەبلەغی قەرز</strong></td>
                        <td class="amount">${Number(data.totalAmount).toLocaleString()} دینار</td>
                    </tr>
                    <tr>
                        <td><strong>کۆی وەرگیراو</strong></td>
                        <td class="paid">${Number(data.totalPaid).toLocaleString()} دینار</td>
                    </tr>
                    <tr>
                        <td><strong>مەبلەغی ماوە</strong></td>
                        <td class="remaining">${Number(data.remainingAmount).toLocaleString()} دینار</td>
                    </tr>
                    <tr>
                        <td><strong>قیستی مانگانە</strong></td>
                        <td>${Number(data.monthlyPayment).toLocaleString()} دینار</td>
                    </tr>
                    <tr>
                        <td><strong>قیستە وەرگیراوەکان</strong></td>
                        <td>${data.paidInstallments} قیست</td>
                    </tr>
                    <tr>
                        <td><strong>بەچەند مانگ</strong></td>
                        <td>${data.months} مانگ</td>
                    </tr>
                    ${data.mobileWaragr ? `
                    <tr>
                        <td><strong>مۆبایلی وەرگر</strong></td>
                        <td>${data.mobileWaragr}</td>
                    </tr>
                    ` : ''}
                    <tr>
                        <td><strong>کەفیل</strong></td>
                        <td>${data.kafeel || '---'}</td>
                    </tr>
                    <tr>
                        <td><strong>بەرواری وەرگرتن</strong></td>
                        <td>${data.loanDate}</td>
                    </tr>
                </tbody>
            </table>

            <!-- جدول تاریخچه قیست‌ها -->
            ${data.installmentHistory && data.installmentHistory.length > 0 ? `
            <div style="margin-top: 30px;">
                <h4 style="text-align: center; color: #2c3e50; margin-bottom: 15px;">مێژووی قیستە وەرگیراوەکان</h4>
                <table class="excel-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>قیست</th>
                            <th>مەبلەغ</th>
                            <th>بەروار</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.installmentHistory.map(installment => `
                            <tr>
                                <td>${installment.number}</td>
                                <td>قیستی ${installment.number} </td>
                                <td class="amount">${Number(installment.amount).toLocaleString()} دینار</td>
                                <td>${installment.date}</td>
                            </tr>
                        `).join('')}
                        <tr class="total-row">
                            <td colspan="2"><strong>کۆی گشتی</strong></td>
                            <td class="amount"><strong>${Number(data.totalPaid).toLocaleString()} دینار</strong></td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            ` : '<div style="text-align: center; color: #7f8c8d; padding: 20px; background: #f8f9fa; border-radius: 6px; margin-top: 20px;">هیچ قیستێک تۆمار نەکراوە</div>'}
        </div>
    `;
    
    customerReport.innerHTML = html;
    customerReport.style.display = 'block';
}


        // نمایش گزارش کامل تمام وام‌های یک وەرگر
function displayAllLoansReport(data) {
    const reportDiv = document.getElementById('all-loans-report');
    
    if (data.error) {
        reportDiv.innerHTML = `
            <div class="error-message">
                ${data.error}
            </div>
        `;
        return;
    }
    
    let loansHTML = '';
    
    data.loans.forEach((loan, index) => {
        loansHTML += `
            <div style="margin-bottom: 40px;">
                <table class="excel-table keep-together">
                    <thead>
                        <tr class="loan-header">
                            <th colspan="2">قەرزی ${index + 1} - ${loan.loanType}</th>
                        </tr>
                        <tr>
                            <th>زانیاری</th>
                            <th>بڕ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>کۆی مەبلەغی قەرز</strong></td>
                            <td class="amount">${Number(loan.totalAmount).toLocaleString()} دینار</td>
                        </tr>
                        <tr>
                            <td><strong>کۆی وەرگیراو</strong></td>
                            <td class="paid">${Number(loan.totalPaid).toLocaleString()} دینار</td>
                        </tr>
                        <tr>
                            <td><strong>مەبلەغی ماوە</strong></td>
                            <td class="remaining">${Number(loan.remainingAmount).toLocaleString()} دینار</td>
                        </tr>
                        <tr>
                            <td><strong>قیستی مانگانە</strong></td>
                            <td>${Number(loan.monthlyPayment).toLocaleString()} دینار</td>
                        </tr>
                        <tr>
                            <td><strong>قیستە وەرگیراوەکان</strong></td>
                            <td>${loan.paidInstallments} قیست</td>
                        </tr>
                        <tr>
                            <td><strong>بەچەند مانگ</strong></td>
                            <td>${loan.months} مانگ</td>
                        </tr>
                        <tr>
                            <td><strong>بەرواری وەرگرتن</strong></td>
                            <td>${loan.loanDate}</td>
                        </tr>
                    </tbody>
                </table>

                ${loan.installmentHistory.length > 0 ? `
                <div style="margin-top: 20px;">
                    <table class="excel-table keep-together">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>قیست</th>
                                <th>مەبلەغ</th>
                                <th>بەروار</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${loan.installmentHistory.map(installment => `
                                <tr>
                                    <td>${installment.number}</td>
                                    <td>قیستی ${installment.number} </td>
                                    <td class="amount">${Number(installment.amount).toLocaleString()} دینار</td>
                                    <td>${installment.date}</td>
                                </tr>
                            `).join('')}
                            <tr class="total-row">
                                <td colspan="2"><strong>کۆی گشتی</strong></td>
                                <td class="amount"><strong>${Number(loan.totalPaid).toLocaleString()} دینار</strong></td>
                                <td></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                ` : ''}
            </div>
        `;
    });
    
    const html = `
        <div class="excel-style-report">
            <div class="excel-header">
                <h3>ڕاپۆرتی تەواو - ${data.waragrName}</h3>
            </div>
            
            <div class="excel-subheader">
                <strong>کۆی گشتی هەموو قەرزەکان</strong>
            </div>

            <!-- جدول خلاصه کل -->
            <table class="excel-table keep-together">
                <thead>
                    <tr>
                        <th>زانیاری</th>
                        <th>بڕ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>کۆی قەرزەکان</strong></td>
                        <td>${data.totalLoans} قەرز</td>
                    </tr>
                    <tr>
                        <td><strong>کۆی مەبلەغی قەرزەکان</strong></td>
                        <td class="amount">${Number(data.totalAllLoans).toLocaleString()} دینار</td>
                    </tr>
                    <tr>
                        <td><strong>کۆی وەرگیراو</strong></td>
                        <td class="paid">${Number(data.totalAllPaid).toLocaleString()} دینار</td>
                    </tr>
                    <tr>
                        <td><strong>کۆی ماوە</strong></td>
                        <td class="remaining">${Number(data.totalAllRemaining).toLocaleString()} دینار</td>
                    </tr>
                    
                </tbody>
            </table>
            
            <div style="margin-top: 40px;">
                <h3 style="text-align: center; color: #2c3e50; margin-bottom: 20px;">زانیارییەکانی هەر قەرزێک</h3>
                ${loansHTML}
            </div>
        </div>
    `;
    
    reportDiv.innerHTML = html;
    reportDiv.style.display = 'block';
}

        // لود گزارشات سیستم
        function loadSystemReports() {
            google.script.run
                .withSuccessHandler(function(data) {
                    displaySystemReports(data);
                })
                .withFailureHandler(function(error) {
                    console.error('هەلە لە وەرگرتنی زانیاری لە سیستەم:', error);
                    document.getElementById('reports').innerHTML = `
                        <div class="error-message">
                            هەلە لە ئامادەکردنی زانیاری لە سیستەم: ${error}
                        </div>
                    `;
                })
                .getSystemReports();
        }

        // نمایش گزارشات سیستم
        function displaySystemReports(data) {
            if (data.error) {
                document.getElementById('reports').innerHTML = `
                    <div class="error-message">
                        ${data.error}
                    </div>
                `;
                return;
            }
            
            // به روزرسانی کارت‌ها
            document.getElementById('total-remaining').textContent = Number(data.totalRemaining).toLocaleString();
            document.getElementById('total-received').textContent = Number(data.totalReceived).toLocaleString();
            document.getElementById('total-amount').textContent = Number(data.totalAmount).toLocaleString();
            document.getElementById('total-loans').textContent = data.totalLoans;
            document.getElementById('active-loans').textContent = data.activeLoans;
            document.getElementById('completed-loans').textContent = data.completedLoans;
            document.getElementById('total-profit').textContent = Number(data.totalProfit).toLocaleString();
            document.getElementById('fund-balance').textContent = Number(data.fundBalance).toLocaleString();
            document.getElementById('total-kreen').textContent = Number(data.totalKreen).toLocaleString();
            
            // به روزرسانی نمودار دایره‌ای
            const completionRate = data.completionRate;
            const ring = document.getElementById('completion-ring');
            const text = document.getElementById('completion-text');
            const circumference = 339.292;
            const offset = circumference - (completionRate / 100) * circumference;
            
            ring.style.strokeDashoffset = offset;
            text.textContent = completionRate + '%';
            
            // به روزرسانی اطلاعات اضافی
            document.getElementById('avg-loan-amount').textContent = 
                data.totalLoans > 0 ? Number(data.totalAmount / data.totalLoans).toLocaleString() + ' دینار' : '0 دینار';
            
            document.getElementById('avg-received').textContent = 
                data.totalLoans > 0 ? Number(data.totalReceived / data.totalLoans).toLocaleString() + ' دینار' : '0 دینار';
            
            document.getElementById('avg-remaining').textContent = 
                data.totalLoans > 0 ? Number(data.totalRemaining / data.totalLoans).toLocaleString() + ' دینار' : '0 دینار';
            
            document.getElementById('active-rate').textContent = 
                data.totalLoans > 0 ? Math.round((data.activeLoans / data.totalLoans) * 100) + '%' : '0%';
            
            document.getElementById('completed-rate').textContent = 
                data.totalLoans > 0 ? Math.round((data.completedLoans / data.totalLoans) * 100) + '%' : '0%';
            
            document.getElementById('profit-rate').textContent = 
                data.totalAmount > 0 ? Math.round((data.totalProfit / data.totalAmount) * 100) + '%' : '0%';
        }

        // تابع برای به‌روزرسانی تمام داده‌ها
        function updateAllData() {
            if (confirm('ئایا دڵنیای کە دەتەوێت هەموو داتاکان نوێ بکەیتەوە؟\nئەم کارە ڕێکخستنەکانی کۆی AH و AI نوێ دەکاتەوە.')) {
                const loadingText = 'نوێکردنەوەی گشت داتاکان...';
                showTempMessage(loadingText);
                
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            showTempMessage('✅ ' + result.message, 'success');
                            // ریلود داده‌ها
                            setTimeout(() => {
                                if (document.getElementById('receive-installment').classList.contains('active')) {
                                    loadWaragrList();
                                }
                                if (document.getElementById('investors').classList.contains('active')) {
                                    loadInvestorsData();
                                }
                                if (document.getElementById('reports').classList.contains('active')) {
                                    loadSystemReports();
                                }
                            }, 2000);
                        } else {
                            showTempMessage('❌ ' + result.message, 'error');
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('هەلە لە نوێکردنەوەی داتاکان:', error);
                        showTempMessage('❌ هەلە لە نوێکردنەوەی داتاکان: ' + error, 'error');
                    })
                    .updateAllData();
            }
        }

        // نمایش پیام موقت
        function showTempMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                ${type === 'success' ? 'background: #27ae60;' : ''}
                ${type === 'error' ? 'background: #e74c3c;' : ''}
                ${type === 'info' ? 'background: #3498db;' : ''}
            `;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // تست ارتباط با سرور
        function testConnection() {
            console.log('تێستی لینکی سێرڤەر...');
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('ئەنجام:', result);
                    alert('پەویوەندی سەرکەوتوو بوو: ' + result.message);
                })
                .withFailureHandler(function(error) {
                    console.error('هەلە لە پەیوەندیکردن:', error);
                    alert('هەلە لە پەیوەندیکردن بە سێرڤەر: ' + error);
                })
                .testConnection();
        }

        // مدیریت ثبت قەرز جدید
        function handleNewLoan(e) {
            e.preventDefault();
            console.log('تۆمارکردنی قیستی نوێ...');
            
            const formData = getLoanFormData();
            console.log('داتاکانی فۆرم:', formData);
            
            if (!formData.waragr || !formData.kreen || !formData.froshtn || !formData.chendaMang) {
                alert('تکایە زانیاریە پێویستەکان بنووسە');
                return;
            }
            
            const successMessage = document.getElementById('loan-success');
            successMessage.style.display = 'block';
            successMessage.textContent = 'تۆمارکردن...';
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('قیست تۆمارکرا:', result);
                    successMessage.textContent = 'قەرز بە سەرکەوتوویی تۆمار کرا';
                    
                    setTimeout(() => {
                        successMessage.style.display = 'none';
                    }, 3000);
                    
                    document.getElementById('loan-form').reset();
                    calculateSud();
                    loadWaragrList();
                })
                .withFailureHandler(function(error) {
                    console.error('هەلە لە تۆماری قەرز:', error);
                    successMessage.style.display = 'none';
                    alert('هەڵە لە تۆمارکردنی قەرز: ' + error);
                })
                .saveNewLoan(formData);
        }

        // مدیریت ثبت قیست
        function handleInstallment(e) {
            e.preventDefault();
            console.log('تۆمارکردنی قیست...');
            
            const formData = getInstallmentFormData();
            console.log('داتاکانی قیست:', formData);
            
            if (!formData.waragr) {
                alert('تکایە وەرگر هەڵبژێرە');
                return;
            }
            
            if (!formData.amount || formData.amount === '0') {
                alert('تکایە مەبلەغی قیست بنووسە');
                return;
            }
            
            const successMessage = document.getElementById('installment-success');
            successMessage.style.display = 'block';
            successMessage.textContent = 'تۆمارکردنی قیست...';
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('قیست تۆمارکرا:', result);
                    
                    successMessage.textContent = `قیستی ${result.installmentNumber}  بە سەرکەوتوویی تۆمار کرا`;
                    
                    document.getElementById('installment-amount').value = '';
                    loadWaragrInfo();
                    
                    setTimeout(() => {
                        successMessage.style.display = 'none';
                    }, 3000);
                    
                })
                .withFailureHandler(function(error) {
                    console.error('هەلە لە تۆمارکردنی قیست:', error);
                    successMessage.style.display = 'none';
                    alert('هەڵە لە تۆمارکردنی قیست: ' + error);
                })
                .saveInstallment(formData);
        }

        // دریافت داده‌های فرم قەرز
        function getLoanFormData() {
            return {
                waragr: document.getElementById('waragr').value,
                mobileWaragr: document.getElementById('mobile-waragr').value,
                jorQist: document.getElementById('jor-qist').value,
                beruar: document.getElementById('beruar').value,
                kreen: document.getElementById('kreen').value.replace(/,/g, '') || '0',
                froshtn: document.getElementById('froshtn').value.replace(/,/g, '') || '0',
                nerxiSud: document.getElementById('nerxi-sud').value.replace('%', '') || '0',
                chendaMang: document.getElementById('chenda-mang').value || '0',
                kafeel: document.getElementById('kafeel').value,
                mobileKafeel: document.getElementById('mobile-kafeel').value,
                froshyar: document.getElementById('froshyar').value,
                notes: document.getElementById('notes').value
            };
        }

        // دریافت داده‌های فرم قیست
        function getInstallmentFormData() {
            const loanType = document.getElementById('select-loan-type').value;
            const waragrName = document.getElementById('select-waragr').value;
            
            return {
                waragr: waragrName,
                loanType: loanType,
                amount: document.getElementById('installment-amount').value.replace(/,/g, '') || '0',
                date: document.getElementById('installment-date').value
            };
        }

        // تابع تغییر تب‌ها
        function openTab(tabName) {
            console.log('گۆرینی لاپەرە بۆ:', tabName);
            
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            const tabButtons = document.getElementsByClassName('tab-button');
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
            
            if (tabName === 'receive-installment') {
                loadWaragrList();
                document.getElementById('customer-report').style.display = 'none';
                document.getElementById('loan-type-selection').style.display = 'none';
            } else if (tabName === 'waragr-reports') {
                loadUniqueWaragrList();
                document.getElementById('all-loans-report').style.display = 'none';
            } else if (tabName === 'reports') {
                loadSystemReports();
            } else if (tabName === 'investors') {
                loadInvestorsData();
            }
        }

       // لود داده‌های سرمایه‌گذاران - نسخه کامل با سود واقعی
function loadInvestorsData() {
    console.log('ئامادەکردنی داتای خاوەن پشکەکان...');
    const investorsContent = document.getElementById('investors-content');
    investorsContent.innerHTML = '<div class="loading">ئامادەکردن...</div>';
    
    google.script.run
        .withSuccessHandler(function(result) {
            console.log('داتای خاوەن پشکەکان وەرگیرا:', result);
            
            if (result.success) {
                let html = '';
                
                // جدول خاوەن پشکەکان (سود بالقوه)
                if (result.investorsData && result.investorsData.length > 0) {
                    html += `
                        <h3>خاوەن پشکەکان - قازانجی کۆتایی</h3>
                        <p style="color: #666; margin-bottom: 15px; font-size: 16px;">
                            ئەگەر گشت قیستەکان درابن قازانجەکان بەم شێوازە دەبیت
                        </p>
                        <table class="investors-table">
                            <thead>
                                <tr>
                                    <th>ناو</th>
                                    <th>مەبلەغی سەرمایە</th>
                                    <th>ڕێژەی سەرمایە</th>
                                    <th>ڕێژەی قازانج</th>
                                    <th>قازانجی کۆتایی</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    result.investorsData.forEach(investor => {
                        html += `
                            <tr>
                                <td>${investor.name}</td>
                                <td>${Number(investor.investment).toLocaleString()}</td>
                                <td>${investor.percentage}%</td>
                                <td>${investor.profitPercentage}%</td>
                                <td>${Number(investor.profitAmount).toLocaleString()}</td>
                            </tr>
                        `;
                    });
                    
                    html += `</tbody></table>`;
                } else {
                    html += `<p>هیچ زانیاریەکی خاوەن پشکەکان نیە</p>`;
                }
                
                // جدول جدید: سود واقعی
                if (result.actualProfitData && result.actualProfitData.investorsActualProfitData.length > 0) {
    html += `
        <h3 style="margin-top: 40px;">قازانجی راستەقینە تا ئەم ساتە</h3>
        <p style="color: #666; margin-bottom: 15px; font-size: 16px;">
            قازانجی ئەو قیستانەی تا ئێستا دراون
        </p>
        <table class="investors-table">
            <thead>
                <tr>
                    <th>ناو</th>
                    <th>مەبلەغی سەرمایە</th>
                    <th>ڕێژەی سەرمایە</th>
                    <th>ڕێژەی قازانج</th>
                    <th>قازانجی راستەقینە</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    result.actualProfitData.investorsActualProfitData.forEach(investor => {
        html += `
            <tr>
                <td>${investor.name}</td>
                <td>${Number(investor.investment).toLocaleString()}</td>
                <td>${investor.percentage}%</td>
                <td>${investor.actualProfitPercentage}%</td>
                <td>${Number(investor.actualProfitAmount).toLocaleString()}</td>
            </tr>
        `;
    });
    
    html += `</tbody></table>`;
}

// جدول جدید: سود ماه جاری
if (result.currentMonthProfitData && result.currentMonthProfitData.investorsCurrentMonthProfitData.length > 0) {
    const monthNames = ["مانگی - 1", "مانگی - 2", "مانگی - 3", "مانگی - 4", "مانگی - 5", "مانگی - 6", 
                       "مانگی - 7", "مانگی - 8", "مانگی - 9", "مانگی - 10", "مانگی - 11", "مانگی - 12"];
    const currentMonthName = monthNames[result.currentMonthProfitData.currentMonth - 1];
    
    html += `
        <h3 style="margin-top: 40px;">قازانجی مانگی ${currentMonthName} ${result.currentMonthProfitData.currentYear}</h3>
        <p style="color: #666; margin-bottom: 15px; font-size: 16px;">
            قازانجی قیستەکان ئەم مانگە
        </p>
        <table class="investors-table">
            <thead>
                <tr>
                    <th>ناو</th>
                    <th>مەبلەغی سەرمایە</th>
                    <th>ڕێژەی سەرمایە</th>
                    <th>ڕێژەی لە قازانجی سالانە</th>
                    <th>قازانجی ئەم مانگە</th>
                    
                </tr>
            </thead>
            <tbody>
    `;
    
    result.currentMonthProfitData.investorsCurrentMonthProfitData.forEach(investor => {
        html += `
            <tr>
                <td>${investor.name}</td>
                <td>${Number(investor.investment).toLocaleString()}</td>
                <td>${investor.percentage}%</td>
                <td>${investor.currentMonthProfitPercentage}%</td>
                <td>${Number(investor.currentMonthProfitAmount).toLocaleString()}</td>
                
            </tr>
        `;
    });
    
    html += `</tbody></table>`;
    
    // خلاصه سود ماه جاری
    html += `
    <div class="summary-section" style="margin-top: 20px;">
        <h4>کورتەی قازانجی ئەم مانگە</h4>
        <div class="info-grid">
            <div class="info-item">
                <label>قازانجی تەواوی ئەم مانگە:</label>
                <span>${Number(result.currentMonthProfitData.currentMonthTotalProfit).toLocaleString()}</span>
            </div>
        </div>
    </div>
`;
}

// در loadInvestorsData، بعد از جدول سوم این رو اضافه کن:
html += `
  <div style="margin-top: 40px;">
    <h3 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">💰 سەرمایەی بەردەستی خاوەن پشکەکان</h3>
    <table class="investors-table">
      <thead>
        <tr>
          <th>ناو</th>
          <th>سەرمایەی سەرەتایی</th>
          <th>قازانجی کۆتایی</th>
          <th>مەبلەغی کەمکراو</th>
          <th>مەبلەغی بەردەست</th>
          <th>نرخی سەرمایە</th>
        </tr>
      </thead>
      <tbody>
`;

// درخواست به GS برای خواندن برداشت‌ها
google.script.run
  .withSuccessHandler(function(withdrawalsData) {
    // این قسمت بعداً پر میشه
    console.log('برداشت‌ها:', withdrawalsData);
  })
  .withFailureHandler(function(error) {
    console.log('خطا در دریافت برداشت‌ها:', error);
  })
  .getWithdrawalsSummary();

// فعلاً با داده‌های اولیه نمایش میدیم
result.investorsData.forEach(investor => {
  html += `
        <tr>
          <td><strong>${investor.name}</strong></td>
          <td>${investor.investment.toLocaleString()}</td>
          <td style="color: #27ae60;">${investor.profitAmount.toLocaleString()}</td>
          <td style="color: #e74c3c;" id="withdrawals-${investor.name}">درحال بارگذاری...</td>
          <td style="color: #2980b9; font-weight: 700;" id="balance-${investor.name}">درحال بارگذاری...</td>
          <td>${investor.percentage}%</td>
        </tr>
  `;
});

html += `
      </tbody>
    </table>
    <p style="text-align: center; color: #7f8c8d; margin-top: 10px; font-size: 12px;">
      مەبلەغی بەردەست = قازانجی کۆتایی - کۆی کەمکراوەکان
    </p>
  </div>
`;

// تابع برای آپدیت جدول بعد از دریافت داده‌ها
setTimeout(function() {
  google.script.run
    .withSuccessHandler(function(withdrawalsData) {
      if (withdrawalsData.success) {
        withdrawalsData.summary.forEach(investor => {
          const withdrawalsCell = document.getElementById('withdrawals-' + investor.name);
          const balanceCell = document.getElementById('balance-' + investor.name);
          
          if (withdrawalsCell && balanceCell) {
            withdrawalsCell.textContent = investor.totalWithdrawals.toLocaleString();
            balanceCell.textContent = Math.max(0, investor.potentialProfit - investor.totalWithdrawals).toLocaleString();
          }
        });
      }
    })
    .withFailureHandler(function(error) {
      console.log('خطا:', error);
      // نمایش خطا
      result.investorsData.forEach(investor => {
        const withdrawalsCell = document.getElementById('withdrawals-' + investor.name);
        if (withdrawalsCell) {
          withdrawalsCell.textContent = 'خطا در بارگذاری';
          withdrawalsCell.style.color = '#e74c3c';
        }
      });
    })
    .getWithdrawalsSummary();
}, 1000);
     
                // جدول فرۆشیارەکان
                if (result.froshyarData && result.froshyarData.length > 0) {
                    html += `
                        <h3 style="margin-top: 40px;">فرۆشیارەکان</h3>
                        <table class="investors-table">
                            <thead>
                                <tr>
                                    <th>ناو</th>
                                    <th>ژمارەی فرۆشتن</th>
                                    <th>کۆی قازانج</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    result.froshyarData.forEach(froshyar => {
                        html += `
                            <tr>
                                <td>${froshyar.name}</td>
                                <td>${froshyar.count}</td>
                                <td>${Number(froshyar.totalProfit).toLocaleString()}</td>
                            </tr>
                        `;
                    });
                    
                    html += `</tbody></table>`;
                } else {
                    html += `<p style="margin-top: 40px;">هیچ زانیاریەکی فرۆشیارەکان نیە</p>`;
                }

                
              // خلاصه
const totalAllProfit = result.investorsProfit + result.froshyarProfit;

html += `
    <div class="summary-section">
        <h4>کۆی گشتی</h4>
        <div class="info-grid">
            <div class="info-item">
                <label>کۆی سەرمایە:</label>
                <span>${Number(result.totalInvestment).toLocaleString()}</span>
            </div>
            <div class="info-item">
                <label>کۆی گشتی قازانج تا ئێستا:</label>
                <span>${Number(totalAllProfit).toLocaleString()}</span>
            </div>
            <div class="info-item">
                <label>قازانجی راستەقیسنەی خاوەن پشکەکان تا ئێستا:</label>
                <span>${Number(result.actualProfitData.investorsActualProfit).toLocaleString()}</span>
            </div>
            <div class="info-item">
                <label>قازانجی فرۆشیاران تا ئێستا:</label>
                <span>${Number(result.froshyarProfit).toLocaleString()}</span>
            </div>
            <div class="info-item">
                <label>کۆی گشتی قازانجی کۆتایی:</label>
                <span>${Number(result.totalProfit).toLocaleString()}</span>
            </div>
        </div>
    </div>
`;
                
                investorsContent.innerHTML = html;
            } else {
                investorsContent.innerHTML = '<p>هیچ زانیاریەکی خاوەن پشکەکان نیە</p>';
            }
        })
        .withFailureHandler(function(error) {
            console.error('هەلە لە وەرگرتنی زانیاری خاوەن پشکەکان:', error);
            investorsContent.innerHTML = '<p>هەلە لە ئامادەکردنی زانیاری خاوەن پشکەکان</p>';
        })
        .getInvestorsData();

        // جدول چهارم ساده - موجودی و برداشت
try {
  const balanceData = getSimpleBalanceTable();
  if (balanceData.success) {
    html += `
      <div style="margin-top: 40px;">
        <h3 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">💰 موجودی و برداشت‌ها</h3>
        <table class="investors-table">
          <thead>
            <tr>
              <th>نام</th>
              <th>سرمایه اولیه</th>
              <th>سود تخمینی</th>
              <th>جمع برداشت‌ها</th>
              <th>موجودی فعلی</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    balanceData.summary.forEach(investor => {
      html += `
            <tr>
              <td><strong>${investor.name}</strong></td>
              <td>${investor.initialInvestment.toLocaleString()}</td>
              <td style="color: #27ae60;">${investor.totalProfit.toLocaleString()}</td>
              <td style="color: #e74c3c;">${investor.totalWithdrawals.toLocaleString()}</td>
              <td style="color: #2980b9; font-weight: 700;">${investor.currentBalance.toLocaleString()}</td>
            </tr>
      `;
    });
    
    html += `
          </tbody>
        </table>
        <p style="text-align: center; color: #7f8c8d; margin-top: 10px; font-size: 12px;">
          * سود تخمینی بر اساس 10% سرمایه اولیه محاسبه شده است
        </p>
      </div>
    `;
  } else {
    html += `<p style="color: #e74c3c; text-align: center;">خطا در بارگذاری جدول موجودی: ${balanceData.error}</p>`;
  }
} catch (error) {
  html += `<p style="color: #e74c3c; text-align: center;">خطا: ${error.toString()}</p>`;
}
}


        // نمایش خطا
        function showError(message) {
            alert('هەلە: ' + message);
        }


// تابع جایگزین - از تب گزارشات PDF بگیر
function generatePDF(tabId) {
    console.log('دەرکردنی PDF بۆ:', tabId);
    
    // پیدا کردن بخش گزارشات
    const reportContainer = document.querySelector(`#${tabId} .excel-style-report`);
    
    if (!reportContainer) {
        alert('هیچ راپۆرتێک بەردەست نیە');
        return;
    }
    
    const options = {
        margin: 10,
        filename: `QARZAKAN-${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    // ایجاد PDF مستقیم از گزارشات
    html2pdf()
        .from(reportContainer)
        .set(options)
        .save();
}



        // آدرس GS شما
const GS_URL = 'https://script.google.com/macros/s/AKfycbzzY5xhhN6QNcYDFdkUnNk1MOaxcwSF9Rk8Ka7cIlyljihN_PkZwBLmuoS114Ax8ia2gg/exec';

// تابع جایگزین برای google.script.run
async function callGS(functionName, data = {}) {
    try {
        console.log('فراخوانی تابع:', functionName, data);
        
        const response = await fetch(GS_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `function=${functionName}&data=${JSON.stringify(data)}`
        });
        
        const result = await response.json();
        console.log('نتیجه:', result);
        return result;
        
    } catch (error) {
        console.error('خطا در ارتباط با GS:', error);
        return { error: error.toString() };
    }
}

// جایگزین کردن google.script.run
window.google = {
    script: {
        run: {
            withSuccessHandler: (successHandler) => ({
                withFailureHandler: (failureHandler) => ({
                    // برای توابع بدون پارامتر
                    getWaragrList: () => callGS('getWaragrList').then(successHandler).catch(failureHandler),
                    getSystemReports: () => callGS('getSystemReports').then(successHandler).catch(failureHandler),
                    getInvestorsData: () => callGS('getInvestorsData').then(successHandler).catch(failureHandler),
                    getUniqueWaragrNames: () => callGS('getUniqueWaragrNames').then(successHandler).catch(failureHandler),
                    updateAllData: () => callGS('updateAllData').then(successHandler).catch(failureHandler),
                    
                    // برای توابع با پارامتر
                    getWaragrInfo: (waragrName, loanType) => callGS('getWaragrInfo', {waragrName, loanType}).then(successHandler).catch(failureHandler),
                    getAllLoansForWaragr: (waragrName) => callGS('getAllLoansForWaragr', {waragrName}).then(successHandler).catch(failureHandler),
                    saveNewLoan: (formData) => callGS('saveNewLoan', formData).then(successHandler).catch(failureHandler),
                    saveInstallment: (formData) => callGS('saveInstallment', formData).then(successHandler).catch(failureHandler)
                })
            })
        }
    }
};

// تست ارتباط
console.log('🔗 PWA فعال شد - منتظر ارتباط با GS...');

// نمایش دکمه نصب PWA
window.addEventListener('beforeinstallprompt', (e) => {
    console.log('📱 برنامه قابل نصب است');
    
    const installBtn = document.createElement('button');
    installBtn.innerHTML = '📲 نصب برنامه';
    installBtn.style.cssText = `
        position: fixed;
        top: 100px;
        left: 10px;
        z-index: 10000;
        background: #2ecc71;
        color: white;
        border: none;
        padding: 12px 16px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        font-family: Vazirmatn, sans-serif;
    `;
    
    installBtn.onclick = async () => {
        e.prompt();
        installBtn.style.display = 'none';
    };
    
    document.body.appendChild(installBtn);
});
    </script>
</body>
</html>

